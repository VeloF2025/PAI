name: Pack v2.0 Validation

on:
  push:
    branches: [ master, main ]
    paths:
      - 'skills/**'
      - 'docs/check-pack-v2-status.cjs'
      - '.github/workflows/pack-v2-validation.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'skills/**'
      - 'docs/check-pack-v2-status.cjs'

jobs:
  validate-pack-v2:
    name: Validate Pack v2.0 Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Pack v2.0 Validation
        run: node docs/check-pack-v2-status.cjs

      - name: Check validation results
        run: |
          if node docs/check-pack-v2-status.cjs | grep -q "❌ FAIL"; then
            echo "❌ Pack v2.0 validation failed!"
            echo "One or more skills do not meet Pack v2.0 requirements."
            exit 1
          else
            echo "✅ All skills pass Pack v2.0 validation!"
          fi

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pack-v2-validation-report
          path: |
            docs/PACK_V2_REVALIDATION_SUMMARY.md
          retention-days: 30

  run-skill-tests:
    name: Run Pack v2.0 Test Suites
    runs-on: ubuntu-latest

    strategy:
      matrix:
        skill:
          - pai-diagnostics
          - upgrade
          - agent-observability
          - fabric
          - research
          - alex-hormozi-pitch
          - create-skill
          - mcp-builder
          - ffuf
          - python-agent-patterns
          - meta-prompting

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check if skill has test file
        id: check-test
        run: |
          if [ -f "skills/${{ matrix.skill }}/tests/pack-v2.test.ts" ] || [ -f "skills/${{ matrix.skill }}/tests/pack-v2.test.js" ]; then
            echo "has_test=true" >> $GITHUB_OUTPUT
          else
            echo "has_test=false" >> $GITHUB_OUTPUT
          fi

      - name: Install test dependencies
        if: steps.check-test.outputs.has_test == 'true'
        run: npm install --global vitest

      - name: Run skill validation tests
        if: steps.check-test.outputs.has_test == 'true'
        run: |
          cd skills/${{ matrix.skill }}
          if [ -f "tests/pack-v2.test.ts" ]; then
            vitest run tests/pack-v2.test.ts
          elif [ -f "tests/pack-v2.test.js" ]; then
            vitest run tests/pack-v2.test.js
          fi

      - name: Verify skill structure
        run: |
          echo "Validating ${{ matrix.skill }} structure..."

          # Check required files
          if [ ! -f "skills/${{ matrix.skill }}/README.md" ]; then
            echo "❌ Missing README.md"
            exit 1
          fi

          if [ ! -f "skills/${{ matrix.skill }}/INSTALL.md" ]; then
            echo "❌ Missing INSTALL.md"
            exit 1
          fi

          if [ ! -f "skills/${{ matrix.skill }}/VERIFY.md" ]; then
            echo "❌ Missing VERIFY.md"
            exit 1
          fi

          if [ ! -d "skills/${{ matrix.skill }}/src" ]; then
            echo "❌ Missing src/ directory"
            exit 1
          fi

          # Check for code files in src/
          CODE_FILES=$(find "skills/${{ matrix.skill }}/src" -type f \( -name "*.ts" -o -name "*.js" -o -name "*.py" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" \) | wc -l)

          if [ "$CODE_FILES" -eq 0 ]; then
            echo "❌ No code files found in src/"
            exit 1
          fi

          echo "✅ ${{ matrix.skill }} has valid Pack v2.0 structure"
          echo "   - README.md: ✅"
          echo "   - INSTALL.md: ✅"
          echo "   - VERIFY.md: ✅"
          echo "   - src/ directory: ✅"
          echo "   - Code files in src/: $CODE_FILES"

  quality-check:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: [validate-pack-v2, run-skill-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for PACK_* legacy files
        run: |
          LEGACY_FILES=$(find skills -type f \( -name "PACK_README.md" -o -name "PACK_INSTALL.md" -o -name "PACK_VERIFY.md" \) 2>/dev/null | wc -l)

          if [ "$LEGACY_FILES" -gt 0 ]; then
            echo "⚠️  Warning: Found $LEGACY_FILES legacy PACK_* files"
            echo "These should be renamed to remove the PACK_ prefix:"
            find skills -type f \( -name "PACK_README.md" -o -name "PACK_INSTALL.md" -o -name "PACK_VERIFY.md" \)
          else
            echo "✅ No legacy PACK_* files found"
          fi

      - name: Verify all skills documented
        run: |
          SKILL_COUNT=$(find skills -mindepth 1 -maxdepth 1 -type d | wc -l)
          echo "Found $SKILL_COUNT skills in skills/ directory"

          if [ "$SKILL_COUNT" -ne 11 ]; then
            echo "⚠️  Expected 11 skills, found $SKILL_COUNT"
          else
            echo "✅ All 11 expected skills present"
          fi

      - name: Generate validation summary
        if: always()
        run: |
          echo "# Pack v2.0 Validation Summary" > validation-summary.md
          echo "" >> validation-summary.md
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> validation-summary.md
          echo "**Workflow Run**: ${{ github.run_number }}" >> validation-summary.md
          echo "" >> validation-summary.md
          echo "## Validation Results" >> validation-summary.md
          echo "" >> validation-summary.md
          node docs/check-pack-v2-status.cjs >> validation-summary.md

      - name: Upload validation summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-summary
          path: validation-summary.md
          retention-days: 90
